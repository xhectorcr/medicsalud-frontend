<div class="availability-page">
  <div class="page-header">
    <button class="back-button" (click)="onBack()">
      ← Volver a médicos
    </button>

    <div class="title-block">
      <h1 class="page-title">Disponibilidad del médico</h1>
      <p class="page-subtitle">
        Elige una fecha y un horario para agendar tu cita.
      </p>
    </div>
  </div>

  <div class="content-layout">
    <!-- Tarjeta del médico -->
    <section class="doctor-card">
      <div class="doctor-info">
        <img [src]="doctor.photoUrl" [alt]="doctor.name" class="doctor-photo" />

        <div>
          <h2 class="doctor-name">{{ doctor.name }}</h2>
          <p class="doctor-speciality">{{ doctor.speciality }}</p>
          <p class="doctor-clinic">{{ doctor.clinic }}</p>
        </div>
      </div>

      <div class="date-selector">
        <span class="date-label">Fecha</span>
        <input type="date" class="date-input" [(ngModel)]="selectedDate" (ngModelChange)="onDateChange()" />
      </div>
    </section>

    <!-- Horarios -->
    <section class="slots-section">
      <div class="slots-header">
        <h3 class="slots-title">Horarios disponibles</h3>

        <div class="tabs">
          <button class="tab" [class.tab-active]="activeFilter === 'all'" (click)="setFilter('all')">
            Todos
          </button>

          <button class="tab" [class.tab-active]="activeFilter === 'available'" (click)="setFilter('available')">
            Disponibles
          </button>

          <button class="tab" [class.tab-active]="activeFilter === 'booked'" (click)="setFilter('booked')">
            Ocupados
          </button>
        </div>
      </div>

      <div *ngIf="loading" class="estado">Cargando horarios...</div>
      <div *ngIf="errorMessage && !loading" class="estado error">
        {{ errorMessage }}
      </div>

      <div class="slots-list" *ngIf="!loading && !errorMessage">
        <div class="slot-card" *ngFor="let slot of filteredSlots">
          <div class="slot-info">
            <span class="slot-time">{{ slot.time }}</span>

            <span class="slot-status" [ngClass]="{
                'status-available': slot.status === 'available',
                'status-booked': slot.status === 'booked'
              }">
              {{ getStatusLabel(slot.status) }}
            </span>
          </div>

          <div class="slot-actions">
            <button class="slot-button direct" [disabled]="slot.status !== 'available' ||loading"
              (click)="agendarDirecto(slot)">
              Agendar Cita
            </button>

            <button class="slot-button payment" [disabled]="slot.status !== 'available' || loading"
              (click)="onReserve(slot)">
              Con Pago
            </button>
          </div>
        </div>

        <div class="empty-state" *ngIf="filteredSlots.length === 0">
          No hay horarios para este filtro.
        </div>
      </div>
    </section>
  </div>
</div>

<!-- Payment Modal -->
<div class="modal-backdrop" *ngIf="showPaymentModal">
  <div class="modal-card payment-modal">
    <h2 class="modal-title">Procesar Pago</h2>

    <p class="payment-description">
      Complete los datos de su tarjeta para confirmar la reserva de su cita médica.
    </p>

    <div class="payment-summary">
      <div class="summary-row">
        <span>Consulta con {{ doctor.name }}</span>
        <span class="amount">${{ paymentInfo.amount.toFixed(2) }}</span>
      </div>
      <div class="summary-row">
        <span>Fecha:</span>
        <span>{{ selectedDate }}</span>
      </div>
      <div class="summary-row" *ngIf="selectedSlotForPayment">
        <span>Hora:</span>
        <span>{{ selectedSlotForPayment.horaInicio }}</span>
      </div>
    </div>

    <form class="payment-form">
      <div class="form-group">
        <label for="cardHolder">Nombre del Titular</label>
        <input type="text" id="cardHolder" class="form-input" placeholder="Nombre completo"
          [(ngModel)]="paymentInfo.cardHolder" [disabled]="paymentProcessing" name="cardHolder" />
      </div>

      <div class="form-group">
        <label for="cardNumber">Número de Tarjeta</label>
        <input type="text" id="cardNumber" class="form-input card-number" placeholder="1234 5678 9012 3456"
          [(ngModel)]="paymentInfo.cardNumber" (input)="formatCardNumber($event)" [disabled]="paymentProcessing"
          maxlength="19" name="cardNumber" />
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="expiryDate">Fecha de Expiración</label>
          <input type="text" id="expiryDate" class="form-input" placeholder="MM/YY" [(ngModel)]="paymentInfo.expiryDate"
            (input)="formatExpiryDate($event)" [disabled]="paymentProcessing" maxlength="5" name="expiryDate" />
        </div>

        <div class="form-group">
          <label for="cvv">CVV</label>
          <input type="text" id="cvv" class="form-input" placeholder="123" [(ngModel)]="paymentInfo.cvv"
            [disabled]="paymentProcessing" maxlength="3" pattern="[0-9]*" name="cvv" />
        </div>
      </div>
    </form>

    <div class="payment-processing" *ngIf="paymentProcessing">
      <div class="spinner"></div>
      <p>Procesando pago seguro...</p>
    </div>

    <div class="modal-actions">
      <button class="modal-button secondary" (click)="cancelPayment()" [disabled]="paymentProcessing">
        Cancelar
      </button>

      <button class="modal-button primary" (click)="processPayment()" [disabled]="paymentProcessing">
        <span *ngIf="!paymentProcessing">Pagar ${{ paymentInfo.amount.toFixed(2) }}</span>
        <span *ngIf="paymentProcessing">Procesando...</span>
      </button>
    </div>

    <p class="security-note">
      Tu información está protegida y es completamente segura
    </p>
  </div>
</div>


<div class="modal-backdrop" *ngIf="showSuccessModal">
  <div class="modal-card">
    <h2 class="modal-title">Cita reservada correctamente</h2>

    <p class="modal-text" *ngIf="ultimaReserva">
      <strong>Paciente:</strong>
      {{ ultimaReserva.nombrePaciente }} ({{ ultimaReserva.pacienteDni }})<br />
      <strong>Médico:</strong> {{ ultimaReserva.nombreMedico }}<br />
      <strong>Fecha:</strong> {{ ultimaReserva.fechaCita }}<br />
      <strong>Hora:</strong> {{ ultimaReserva.horaCita }}<br />
      <strong>Sede:</strong> {{ ultimaReserva.nombreSede }}
    </p>

    <div class="modal-actions">
      <button class="modal-button secondary" (click)="closeModal()">
        Entendido
      </button>

      <button class="modal-button primary" (click)="goToMisCitas()">
        Ver mis citas
      </button>
    </div>
  </div>
</div>